@using TTS.Domain.DTO
@using TTS.Domain.Domain
@using TTS.Domain.Enum
@model IndexProjectsDto

@{
    ViewData["Title"] = "Сите проекти";
}

<div class="container-fluid my-4">
    <div class="row">

        <!-- Main Content -->
        <div class="col-md-9 container">

            <!-- Existing Content -->
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="text-capitalize">Мои проекти</h4>
                @if (User.IsInRole("Client"))
                {
                    <a asp-action="Create" class="btn btn-primary d-flex align-items-center">
                        <i class="bi bi-plus-circle-dotted me-2"></i> Креирај нов
                    </a>
                }
            </div>

            <form method="get" asp-action="MyProjects">
                <div class="row d-flex justify-content-between mb-3">
                    <div class="col-6 d-flex">
                        <input type="text" name="searchTerm" class="form-control me-2 w-75" placeholder="@(Model.SearchTerm ?? "Пребарај по име на проект")" value="@Context.Request.Query["search"]" />
                        <button type="submit" class="btn btn-outline-primary w-25">
                            <i class="bi bi-search"></i> Пребарај
                        </button>
                    </div>
                    @if (User.IsInRole("Client"))
                    {
                        <div class="col-3">
                            <select class="form-select" name="selectedExpertise" onchange="this.form.submit()">
                                <option value="" selected disabled>-- Избери експертиза --</option>
                                <option value="">Сите</option>
                                @foreach (var expertise in Html.GetEnumSelectList<Expertise>())
                                {
                                    <option value="@expertise.Value" selected="@(Model.SelectedExpertise == Enum.Parse<Expertise>(expertise.Value) ? "selected" : null)">@expertise.Text</option>
                                }
                            </select>
                        </div>
                    }
                </div>

            </form>


            @if (!Model.Projects.Any())
            {
                <hr />
                <div class="row justify-content-center">
                    <div class="col-md-6 text-center p-4 border border-secondary border-dashed rounded-3 bg-light">
                        <i class="fas fa-tasks" style="font-size: 50px; color: #999;"></i>
                        <h2 class="mt-3 text-muted">Нема проекти</h2>
                        @if (User.IsInRole("Client"))
                        {
                            <p class="text-secondary">
                                Започни со креирање на проекти или контактирај го админот на е-маил <strong>admin@admin.com</strong>!
                            </p>
                        }
                        else
                        {
                            <p class="text-secondary">
                                Аплицирај за работа на проекти во делот <strong>Сите проекти</strong> и започни со работа!
                            </p>
                        }
                    </div>
                </div>
            }
            else
            {
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>#</th>
                                <th><i class="bi bi-bookmark"></i> Проект</th>
                                @if (User.IsInRole("Consultant"))
                                {
                                    <th>Клиент</th>
                                }
                                <th>Експертиза</th>
                                <th>Почетен датум</th>
                                <th>Краен рок</th>
                                <th>Статус</th>
                                <th>Завршен на</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var project in Model.Projects)
                            {
                                var statusClass = project.Status switch
                                {
                                    TTS.Domain.Enum.ProjectStatus.New => "text-info",
                                    TTS.Domain.Enum.ProjectStatus.InProgress => "text-warning",
                                    TTS.Domain.Enum.ProjectStatus.Invalid => "text-danger",
                                    _ => "text-success"
                                };

                                <tr onclick="location.href='@Url.Action("Details", "Projects", new { id = project.Id })'">
                                    <td>@(Model.Projects.IndexOf(project) + 1)</td>
                                    <td class="fw-medium">@project.Title</td>
                                    @if (User.IsInRole("Consultant"))
                                    {
                                        <td>@project.CreatedBy.User.FirstName</td>
                                    }
                                    <td>@project.Expertise</td>
                                    <td>@(project.StartDate.ToShortDateString())</td>
                                    <td>@(project.EndDate.ToShortDateString())</td>
                                    <td class="@statusClass">@Html.DisplayFor(model => project.Status)</td>
                                    <td>@(project.CompletedOn)</td>

                                    <td class="text-start">
                                        @if (User.IsInRole("Client"))
                                        {
                                            <a class="btn btn-outline-primary me-3" asp-action="Edit" asp-route-id="@project.Id">Промени</a>
                                            <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#myModal" onclick="event.stopPropagation();">
                                                Избриши
                                            </button>

                                            <div class="modal fade" tabindex="-1" id="myModal">
                                                <div class="modal-dialog">
                                                    <div class="modal-content">
                                                        <div class="modal-header">
                                                            <h5 class="modal-title">Дали сте сигурни дека сакате да го избришете проектот @(project.Title)?</h5>
                                                        </div>
                                                        <div class="modal-body">
                                                            <p>Со клик на копчето потврди ќе го избриешете проектот засекогаш!</p>
                                                        </div>
                                                        <div class="modal-footer">
                                                            <a class="btn btn-secondary"
                                                                    data-bs-dismiss="modal"
                                                                    onclick="event.stopPropagation();"
                                                                    asp-action="MyProjects">
                                                                Откажи
                                                            </a>
                                                            <form asp-action="DeleteConfirmed" method="post">
                                                                <input type="hidden" name="id" value="@project.Id" />
                                                                <button type="submit" class="btn btn-danger" onclick="event.stopPropagation();">Потврди</button>
                                                            </form>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>
    </div>
</div>